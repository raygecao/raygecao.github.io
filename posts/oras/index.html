<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>私有化交付下的应用打包方案 - 拾遗之途</title><meta name=Description content><meta property="og:title" content="私有化交付下的应用打包方案">
<meta property="og:description" content="私有化交付的三要求：可复现性，易操作性和易维护性。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://raygecao.github.io/posts/oras/"><meta property="og:image" content="https://raygecao.github.io/posts/oras/featured-image.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-08-26T20:58:05+08:00">
<meta property="article:modified_time" content="2021-08-26T20:58:05+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://raygecao.github.io/posts/oras/featured-image.png">
<meta name=twitter:title content="私有化交付下的应用打包方案">
<meta name=twitter:description content="私有化交付的三要求：可复现性，易操作性和易维护性。">
<meta name=application-name content="拾遗之途">
<meta name=apple-mobile-web-app-title content="拾遗之途">
<meta name=google-site-verification content="OzXJ6LYRvjcbIN3W9Dn7TA7in9F1AYZjd2pciC8sexc"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://raygecao.github.io/posts/oras/><link rel=prev href=https://raygecao.github.io/posts/oci-image/><link rel=next href=https://raygecao.github.io/posts/container-from-scratch/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"私有化交付下的应用打包方案","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/raygecao.github.io\/posts\/oras\/"},"image":[{"@type":"ImageObject","url":"https:\/\/raygecao.github.io\/posts\/oras\/featured-image.png","width":700,"height":373}],"genre":"posts","keywords":"container","wordcount":5911,"url":"https:\/\/raygecao.github.io\/posts\/oras\/","datePublished":"2021-08-26T20:58:05+08:00","dateModified":"2021-08-26T20:58:05+08:00","publisher":{"@type":"Organization","name":"raygecao"},"author":{"@type":"Person","name":"raygecao"},"description":""}</script></head>
<body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=拾遗之途>拾遗之途</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> 文章 </a><a class=menu-item href=/tags/> 标签 </a><a class=menu-item href=/categories/> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title=拾遗之途>拾遗之途</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
取消
</a>
</div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>目录</h2>
<div class="toc-content always-active" id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">私有化交付下的应用打包方案</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=" author" class=author><i class="fas fa-user-circle fa-fw"></i>raygecao</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%8E%A2%E7%B4%A2%E4%B8%8E%E5%AE%9E%E6%88%98/><i class="far fa-folder fa-fw"></i>探索与实战</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-08-26>2021-08-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5911 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 12 分钟&nbsp;<span id=/posts/oras/ class=leancloud_visitors data-flag-title=私有化交付下的应用打包方案>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div>
</div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/posts/oras/featured-image.png data-srcset="/posts/oras/featured-image.png, /posts/oras/featured-image.png 1.5x, /posts/oras/featured-image.png 2x" data-sizes=auto alt=/posts/oras/featured-image.png title=/posts/oras/featured-image.png></div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#私有化交付>私有化交付</a></li>
<li><a href=#一个应用部署需要啥>一个应用部署需要啥？</a></li>
<li><a href=#当前交付方案>当前交付方案</a></li>
<li><a href=#优化方向>优化方向</a>
<ul>
<li><a href=#统一制品仓库>统一制品仓库</a></li>
<li><a href=#公网发布中心改造>公网发布中心改造</a></li>
<li><a href=#增量发布>增量发布</a></li>
</ul>
</li>
<li><a href=#优化方案>优化方案</a>
<ul>
<li><a href=#现有开源项目参考>现有开源项目参考</a></li>
<li><a href=#组织结构>组织结构</a></li>
</ul>
</li>
<li><a href=#实践探索>实践探索</a>
<ul>
<li><a href=#准备阶段>准备阶段</a></li>
<li><a href=#上传制品>上传制品</a></li>
<li><a href=#打包bundle>打包bundle</a></li>
<li><a href=#下载bundle>下载bundle</a></li>
<li><a href=#加载bundle>加载bundle</a></li>
<li><a href=#多层结构>多层结构</a></li>
<li><a href=#补丁机制>补丁机制</a></li>
</ul>
</li>
<li><a href=#总结>总结</a></li>
</ul>
</nav></div>
</div><div class=content id=content><p>私有化交付的三要求：可复现性，易操作性和易维护性。</p>
<h2 id=私有化交付>私有化交付</h2>
<p>公有云交付和私有化交付是ToB服务交付两种重要手段。公有云交付成本较低，数据安全性及性能的要求不需要太高，<strong>通常允许连接外网</strong>；而私有化交付一定程度上避免的资源的复用与共享，成本较高，但数据安全性高，适合数据敏感度高的企业，这些企业中大部分<strong>不允许连接外网</strong>。综上，私有化交付在数据安全很高的事业单位、银行及政府部门中占据主导地位。</p>
<p>私有化交付的一个重要的应用场景是<strong>如何将一组服务部署到与外部隔绝的内网环境</strong>，这也是我们今天研究的主题。本文不深入探究平台等基建是如何bootstrap出来，毕竟这个topic要溯源的话甚至要问一问服务器是哪来的。我们更专注于应用的打包方案。</p>
<p>显然，在网络受限的环境下，应用相关的所有资源都只能通过人肉搬运。下面的模式是私有化交付场景下常见的模式。</p>
<div class=mermaid id=id-1></div>
<h2 id=一个应用部署需要啥>一个应用部署需要啥？</h2>
<ul>
<li><strong>镜像</strong>：容器化是私有化交付的关键，而容器化中最重要的组成就是image，image在服务部署中是不可或缺的。</li>
<li><strong>编排文件与配置信息（应用包）</strong>：私有化交付的特点是允许较高程度上的定制：不同私有化集群受节点数目、资源条件、特殊需求等因素，对服务的配置有着不同的需求。为了尽可能地自动化，将编排及默认配置打包在应用中是不错的选择，其中比较经典的例子是<strong>helm chart</strong>。编排及配置相当于应用管理工具包，有了它可以便于部署的自动化，但并不像image那么刚需。</li>
<li><strong>数据包</strong>：应用中的部分服务可能会依赖于某些数据包，如算法模型、调试工具包等。服务相关的附属物件的都可以认为是一种数据包。是否需要数据包是具体服务确定的。</li>
</ul>
<p>打包应用，无外乎将应用所需的上述的所有组件pack起来带到现场进行部署。</p>
<h2 id=当前交付方案>当前交付方案</h2>
<p>镜像/编排/数据包各自有着不同的发布流程，并且各自的发布中心独立，比如：</p>
<ul>
<li>镜像的发布中心可以是docker registry。</li>
<li>编排包的发布中心可以是chart museum。</li>
<li>数据包的发布中心可以是某个s3。</li>
</ul>
<p>为保证系统的可复现性，意味着现场环境也需要mirror这些infra，结构大致如下：</p>
<figure><a class=lightgallery href=/posts/oras/old-pack.png title=/posts/oras/old-pack.png data-thumbnail=/posts/oras/old-pack.png data-sub-html="<h2>当前mirror方案</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=old-pack.png data-srcset="/posts/oras/old-pack.png, old-pack.png 1.5x, /posts/oras/old-pack.png 2x" data-sizes=auto alt=/posts/oras/old-pack.png height=200 width=600>
</a><figcaption class=image-caption>当前mirror方案</figcaption>
</figure>
<p>这个架构存在两个痛点：</p>
<ul>
<li>发布中心分散，无法进行统一管理，增加维护成本。</li>
<li>公网中将各个组件打成一个tar包，隔离性太强，很多版本的image/数据包没有变化，存在同一组件打包多份的情况。这增加了打包时长，浪费公网存储资源。</li>
</ul>
<h2 id=优化方向>优化方向</h2>
<h3 id=统一制品仓库>统一制品仓库</h3>
<p>为解决第一个问题，我们考虑是否可以将这些发布中心归拢在一起。我们把上面提及的镜像，应用包及数据包统一描述为<strong>制品（artifact）</strong>，我们需要一个统一制品仓库来实现这些制品的发布。而OCI registry是个不错的选择，理由是：</p>
<ul>
<li>OCI registry即满足<a href=https://github.com/opencontainers/distribution-spec/blob/main/spec.md target=_blank rel="noopener noreffer">OCI Distribution Spec</a>的registry，很多开源产品实现了此规范，如docker registry, harbor, nexus等。灵活性较强，可以根据发布规模、运维需求等因素灵活选型。</li>
<li>OCI registry天然支持docker image的发布。上述制品中，只有image的发布最为复杂，<a href=https://github.com/opencontainers/image-spec/blob/main/spec.md target=_blank rel="noopener noreffer">OCI Image Format Spec</a>里定义的镜像格式是基于content-addressed的，而一般的存储系统都是location-addressed，使用registry统一制品会相对简单一些。</li>
<li>普通制品使用OCI registry存储已存在开源的解决方案<a href=https://github.com/oras-project/oras target=_blank rel="noopener noreffer">oras</a> (OCI registry as storage)，可以方便地实现content-addressable 特性。</li>
</ul>
<h3 id=公网发布中心改造>公网发布中心改造</h3>
<p>公网发布中心面临的最大问题就是存储空间的浪费。由于不同应用间以及同一应用各版本均为彼此隔离地打包上传，这导致了公网发布中心无法对内容做任何复用，经常一份镜像要重复打包成百上千次（比如ubuntu 这种base image），极大的浪费了存储空间。</p>
<p>一个显而易见的优化方向是将公网发布中心向着OCI registry方向改造，这样很多content可以被复用，这会带来一系列的好处：</p>
<ul>
<li>节省了大量存储空间。</li>
<li>利用layer cache可以节省打包上传的时间。</li>
<li>可以增加layer粒度的diff机制，用户在公网下在新版本的应用时，只需要下载对应的patch即可，提升交付效率。</li>
</ul>
<div class="details admonition tip open">
<div class="details-summary admonition-title">
<i class="icon fas fa-lightbulb fa-fw"></i>技巧<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content>如果公网也是OCI registry，那么包的上传就有点类似于docker push，当上传的layer在registry已存在时，对应的blob将不会重复上传。只有新增的layer blob会被上传，形式上类似于增加了一层layer cache。</div>
</div>
</div>
<h3 id=增量发布>增量发布</h3>
<p>如果app bundle尺寸很大的话，会对交付效率带来较大的影响。</p>
<ul>
<li>下载应用包耗时较长。</li>
<li>应用包占用的存储空间较大，并且应用包的跨网离线拷贝耗时较长。</li>
<li>现场环境加载应用包并上传耗时较长。</li>
</ul>
<div class="details admonition info open">
<div class="details-summary admonition-title">
<i class="icon fas fa-info-circle fa-fw"></i>交付效率<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content>交付效率并没有一个官方的定义，我们这里姑且用<strong>将一个应用从公司内网环境mirror到现场环境并成功部署所耗费的时间</strong>来表述。增量发布只会影响mirror的效率，对部署效率不会有影响。</div>
</div>
</div>
<p>初次交付时，这一问题无法避免，因为这时现场是个空的registry，需要mirror应用所需的所有artifacts。但是如果现场因新需求或bugfix等原因需要升级时，就不需要mirror另一个版本的全部content了。我们可以对这两个版本的bundle进行diff，生成一个补丁包来承载<strong>新版本存在，但老版本不存在的blob集合</strong>。如下图所示，app从v1.0.0升级到v1.0.1仅需要将<code>M2</code>与<code>L4</code>打到补丁包里即可，即其复用了就版本的<code>L1</code>与<code>L2</code>两个blob。</p>
<div class=mermaid id=id-2></div>
<p>增量发布对于小版本bugfix效率很高，改动越小，可以复用的layer越多，补丁包就越小，交付效率也就越高。</p>
<h2 id=优化方案>优化方案</h2>
<h3 id=现有开源项目参考>现有开源项目参考</h3>
<ul>
<li>
<p><a href=https://github.com/oras-project/oras-go target=_blank rel="noopener noreffer">ORAS</a>：使用OCI registry存储artifacts。</p>
<ul>
<li>可以将若干文件以layer的方式存到某个repository下。</li>
<li>push操作只能实现一层关联，即manifest => layers+config。</li>
<li>依赖特定annotation，无法与docker image兼容，即无法pull出docker image。</li>
</ul>
</li>
<li>
<p><a href=https://github.com/google/go-containerregistry target=_blank rel="noopener noreffer">crane</a>: 与registry交互的go lib。</p>
<ul>
<li>基本封装了OCI Distribution Spec。</li>
<li>与image format绑定较深，对OCI Artifacts支持不完善，尤其是对index的支持。</li>
</ul>
</li>
<li>
<p><a href=https://github.com/cnabio/cnab-to-oci target=_blank rel="noopener noreffer">cnab-to-oci</a>：使用OCI registry来发布应用包（application bundle），其引入了打包的概念，将若干Image打包成一个bundle，并在registry中流转。</p>
<ul>
<li>突出了app bundle的概念，便于应用整体的管理。</li>
<li>与Docker Image Format Spec强绑定，底层调用moby sdk，无法支持通用的artifacts。</li>
</ul>
</li>
<li>
<p><a href=https://github.com/helm/helm/tree/main/internal/experimental/registry target=_blank rel="noopener noreffer">helm registry</a>：chart 支持基于OCI registry的发布。</p>
<ul>
<li>local cache以OCI <a href=https://github.com/opencontainers/image-spec/blob/main/image-layout.md target=_blank rel="noopener noreffer">image-layout</a>结构组织，content addressabe & location addressable。</li>
<li>与registry的交互必须依赖于local cache。</li>
<li>同样仅支持两层镜像结构</li>
</ul>
</li>
<li>
<p><a href=https://github.com/containerd/containerd target=_blank rel="noopener noreffer">containered</a> 一个容器运行时的标准，其中<code>images</code>pkg包含对OCI image format的处理，<code>remotes</code>pkg包含与registry交互的底层sdk。</p>
<ul>
<li>兼容全部的OCI Spec。</li>
<li>封装度低，对image的处理十分通用，不局限于docker image。</li>
</ul>
</li>
</ul>
<h3 id=组织结构>组织结构</h3>
<p>打包操作无非是将若干的artifacts包在一起，并给其一个用于定位的reference（包名），而其对偶的拆包操作就是根据包名能获取到所有artifacts。</p>
<p><a href=https://cnab.io/ target=_blank rel="noopener noreffer">cnab</a>给我们提供一个很好的组织方式的参考，bundle reference作为检索的入口，可以关联到所有的artifacts，形式上就类似于一个<a href=https://github.com/opencontainers/image-spec/blob/main/image-index.md target=_blank rel="noopener noreffer">image index</a>与<a href=https://github.com/opencontainers/image-spec/blob/main/manifest.md target=_blank rel="noopener noreffer">image manifest</a>之间的关系。</p>
<figure><a class=lightgallery href=/posts/oras/bundle-struct.png title=/posts/oras/bundle-struct.png data-thumbnail=/posts/oras/bundle-struct.png data-sub-html="<h2>cnab&rsquo;s bundle format in OCI registry</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=bundle-struct.png data-srcset="/posts/oras/bundle-struct.png, bundle-struct.png 1.5x, /posts/oras/bundle-struct.png 2x" data-sizes=auto alt=/posts/oras/bundle-struct.png height=200 width=500>
</a><figcaption class=image-caption>cnab&rsquo;s bundle format in OCI registry</figcaption>
</figure>
<p>简化一下组织结构，本质上就是一颗多叉树。</p>
<div class=mermaid id=id-3></div>
<h2 id=实践探索>实践探索</h2>
<p>我们以一个具体的例子来简化一下我们要解决的问题：我<strong>们如何使用helm在私有化k8s集群中部署起来一个nginx服务</strong>。我们要做的是将helm chart与image发布并打包，在现场环境中导入这些artifacts。</p>
<p>结合oras, crane与containerd sdk开发一个小工具<strong>cb</strong>，提供如下核心功能</p>
<table>
<thead>
<tr>
<th>cmd</th>
<th>作用</th>
<th>实现要点</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>push</code></td>
<td>上传普通制品（非docker image）</td>
<td>对<code>oras.Push</code>做简单封装</td>
</tr>
<tr>
<td><code>pull</code></td>
<td>下载普通制品，是push的对偶操作</td>
<td>对<code>oras.Pull</code>做简单封装</td>
</tr>
<tr>
<td><code>bundle</code></td>
<td>打包生成bundle，将一组制品关联起来</td>
<td>生成index索引artifact list，并将index及artifacts push到registry中特定的repository里</td>
</tr>
<tr>
<td><code>pack</code></td>
<td>将registry中的bundle保存到本地</td>
<td>以OCI image-layout的形式存储上述结构，相关的reference通过特殊的annotation记录在<code>index.json</code>中</td>
</tr>
<tr>
<td><code>load</code></td>
<td>从OCI image-layout中恢复bundle</td>
<td>加载OCI image-layout中的<code>index.json</code>并将关联的content及reference push到registry</td>
</tr>
<tr>
<td><code>diff</code></td>
<td>比较并产生target reference相对source reference的patch包</td>
<td>形式仍以OCI image-layout存在，只是<code>blobs</code>与<code>index.json</code>中存在的是两个ref之间的diff，而非全量的引用关系。一般来讲，diff产生的patch包，脱离了source reference是无法加载的</td>
</tr>
<tr>
<td><code>patch</code></td>
<td>加载patch包</td>
<td>Provider需要结合source reference与patch包构建完整target reference。另外patch包里记录source与target是一个不错的选择</td>
</tr>
</tbody>
</table>
<p>此外<strong>cb</strong>还wrap了<strong>crane</strong>的<code>manifest</code>，<code>catalog</code>及<code>list</code> 功能，另外结合了<a href=https://github.com/goccy/go-graphviz target=_blank rel="noopener noreffer">go-graphviz</a>实现了OCI layer可视化功能。</p>
<h3 id=准备阶段>准备阶段</h3>
<ul>
<li>
<p>在本地起一个docker registry（确保registry是干净的），并添加dns <strong>myregistry</strong>。</p>
</li>
<li>
<p>在docker hub上下载<code>ubuntu:21.04</code>和<code>nginx:1.21.1</code>，以及使用helm create创建默认的nginx chart。</p>
</li>
</ul>
<h3 id=上传制品>上传制品</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=c1># push chart</span>
$ cb push myregistry:5000/nginx-chart:1.0.0 --files mychart

<span class=c1># push nginx image</span>
$ docker tag nginx:1.21.1 myregistry:5000/nginx:1.21.1
$ docker push myregistry:5000/nginx:1.21.1

$ cb catalog myregistry:5000 <span class=c1># 列出registry中的repositories</span>
NO.	NAME
<span class=m>0</span>  	nginx
<span class=m>1</span>  	nginx-chart
</code></pre></td></tr></table>
</div>
</div><p>Push仅仅包装了oras cli，nginx chart的manifest如下</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
  <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.unknown.config.v1+json&#34;</span><span class=p>,</span>
    <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a&#34;</span><span class=p>,</span>
    <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>2</span>
  <span class=p>},</span>
  <span class=nt>&#34;layers&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.layer.v1.tar+gzip&#34;</span><span class=p>,</span>
      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:64f02409c5583265a67390256055c95902696345bdfb46a566b14ea9eac7c306&#34;</span><span class=p>,</span>
      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>3943</span><span class=p>,</span>
      <span class=nt>&#34;annotations&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;io.deis.oras.content.digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:f2c5bf294ce3a1fcd249c00df5f916135059d107cc3f35c92c86189b7113d74e&#34;</span><span class=p>,</span>
        <span class=nt>&#34;io.deis.oras.content.unpack&#34;</span><span class=p>:</span> <span class=s2>&#34;true&#34;</span><span class=p>,</span>
        <span class=nt>&#34;org.opencontainers.image.title&#34;</span><span class=p>:</span> <span class=s2>&#34;mychart&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=打包bundle>打包bundle</h3>
<p>定义nginx-app bundle，tag为v1.0.0，包含nginx镜像与nginx chart。bundle.yaml简化如下</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myregistry:5000/nginx-app</span><span class=w>
</span><span class=w></span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>v1.0.0</span><span class=w>
</span><span class=w></span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myregistry:5000/nginx:1.21.1&#34;</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myregistry:5000/nginx-chart:1.0.0&#34;</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ cb bundle nginx-bundle.yaml <span class=c1># 打包nginx-app</span>
</code></pre></td></tr></table>
</div>
</div><p><code>nginx-app:v1.0.0</code>的index如下，reference记录在<code>org.opencontainers.image.ref.name</code> annotation里，这个reference（tag）需要被记录并在现场加载时恢复。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
  <span class=nt>&#34;manifests&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.manifest.v1+json&#34;</span><span class=p>,</span>
      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:053598290cc6fad47d9af8f98baa939d6ebb92f672f7a1871e29cb55a85f2964&#34;</span><span class=p>,</span>
      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>257</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span><span class=p>,</span>
      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:5e95e5eb8be4322e3b3652d737371705e56809ed8b307ad68ec59ddebaaf60e4&#34;</span><span class=p>,</span>
      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>1570</span><span class=p>,</span>
      <span class=nt>&#34;annotations&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;org.opencontainers.image.ref.name&#34;</span><span class=p>:</span> <span class=s2>&#34;myregistry:5000/nginx:1.21.1&#34;</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.manifest.v1+json&#34;</span><span class=p>,</span>
      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:7ca59b0f5387479b242896fa0c507d8c29dfa5292100a5576f8663a546e41611&#34;</span><span class=p>,</span>
      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>602</span><span class=p>,</span>
      <span class=nt>&#34;annotations&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;org.opencontainers.image.ref.name&#34;</span><span class=p>:</span> <span class=s2>&#34;myregistry:5000/nginx-chart:1.0.0&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=下载bundle>下载bundle</h3>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=c1># 将niginx-app bundle下载到nginx-app目录下</span>
$ cb pack myregistry:5000/nginx-app:v1.0.0 -o nginx-app 

<span class=c1># 验证nginx-app中的结构符合OCI Image Layer Spec</span>
$ tree nginx-app
nginx-app
├── blobs
│   └── sha256
│       ├── 053598290cc6fad47d9af8f98baa939d6ebb92f672f7a1871e29cb55a85f2964
│       ├── 12455f71a9b5e0c207a601fb32bcf7f10a933d7193574d968409bbc5c2d89fe0
│       ├── 2a53fa598ee20ad436f2f9da7c0a21cce583bd236f47828895d771fb2e8795e1
│       ├── 44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a
│       ├── 572061c855037851b6384e6bba08cb7d48f71e74631865641518644ba1469e32
│       ├── 5e95e5eb8be4322e3b3652d737371705e56809ed8b307ad68ec59ddebaaf60e4
│       ├── 64f02409c5583265a67390256055c95902696345bdfb46a566b14ea9eac7c306
│       ├── 7ca59b0f5387479b242896fa0c507d8c29dfa5292100a5576f8663a546e41611
│       ├── 9e324aa228dbd3c1b80ea7c20b6d63b897605fa92f168ccce976a2df42375e77
│       ├── b86f2ba62d17b165964516228297d3ba669d60b6a283b5fd7779b27d7ec33871
│       ├── dd34e67e3371dc2d1328790c3157ee42dfcae74afffd86b297459ed87a98c0fb
│       ├── e1acddbe380c63f0de4b77d3f287b7c81cd9d89563a230692378126b46ea6546
│       ├── e21006f71c6fb784a76159590b6ba8ab3fb22e5026f67abcf5feb8e4231837d6
│       └── f3341cc17e586daa9660abf087f13b2eba247bcf6646ee972e85d4cbaf18dbae
├── index.json
├── ingest
└── oci-layout

<span class=c1># 查看index内容，相当于把nginx-app在全局index中拍平</span>
$ cat nginx-app/index.json<span class=p>|</span> jq .
<span class=o>{</span>
  <span class=s2>&#34;schemaVersion&#34;</span>: 2,
  <span class=s2>&#34;manifests&#34;</span>: <span class=o>[</span>
    <span class=o>{</span>
      <span class=s2>&#34;mediaType&#34;</span>: <span class=s2>&#34;application/vnd.oci.image.index.v1+json&#34;</span>,
      <span class=s2>&#34;digest&#34;</span>: <span class=s2>&#34;sha256:572061c855037851b6384e6bba08cb7d48f71e74631865641518644ba1469e32&#34;</span>,
      <span class=s2>&#34;size&#34;</span>: 674,
      <span class=s2>&#34;annotations&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;org.opencontainers.image.ref.name&#34;</span>: <span class=s2>&#34;myregistry:5000/nginx-app:v1.0.0&#34;</span>
      <span class=o>}</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;mediaType&#34;</span>: <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
      <span class=s2>&#34;digest&#34;</span>: <span class=s2>&#34;sha256:5e95e5eb8be4322e3b3652d737371705e56809ed8b307ad68ec59ddebaaf60e4&#34;</span>,
      <span class=s2>&#34;size&#34;</span>: 1570,
      <span class=s2>&#34;annotations&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;org.opencontainers.image.ref.name&#34;</span>: <span class=s2>&#34;myregistry:5000/nginx:1.21.1&#34;</span>
      <span class=o>}</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;mediaType&#34;</span>: <span class=s2>&#34;application/vnd.oci.image.manifest.v1+json&#34;</span>,
      <span class=s2>&#34;digest&#34;</span>: <span class=s2>&#34;sha256:7ca59b0f5387479b242896fa0c507d8c29dfa5292100a5576f8663a546e41611&#34;</span>,
      <span class=s2>&#34;size&#34;</span>: 602,
      <span class=s2>&#34;annotations&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;org.opencontainers.image.ref.name&#34;</span>: <span class=s2>&#34;myregistry:5000/nginx-chart:1.0.0&#34;</span>
      <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>]</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=加载bundle>加载bundle</h3>
<p>删除掉registry中的内容并重启，将nginx-app加载到registry中，可以恢复完整的nginx-app bundle。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ cb load nginx-app
</code></pre></td></tr></table>
</div>
</div><h3 id=多层结构>多层结构</h3>
<p>当前打包策略实现了OCI Artifacts的高扩展性，结构树可以灵活地向上延展，比如bundle里嵌套bundle。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myregistry:5000/ubuntu-nginx-app</span><span class=w>
</span><span class=w></span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>v1.0.0</span><span class=w>
</span><span class=w></span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myregistry:5000/nginx-app:v1.0.0&#34;</span><span class=w> </span><span class=c># 这是一个bundle</span><span class=w>
</span><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;myregistry:5000/ubuntu:21.04&#34;</span><span class=w>  </span><span class=c># 这是一个image</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>打包后，<code>ubuntu-nginx-app:v1.0.0</code>的index如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;schemaVersion&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
  <span class=nt>&#34;manifests&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=p>{</span>
      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.manifest.v1+json&#34;</span><span class=p>,</span>
      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:52e0a43cc3025f0814510022bc2bc7f64135a9f4c93944ea0b82df344cc798c0&#34;</span><span class=p>,</span>
      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>257</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.oci.image.index.v1+json&#34;</span><span class=p>,</span>
      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:572061c855037851b6384e6bba08cb7d48f71e74631865641518644ba1469e32&#34;</span><span class=p>,</span>
      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>674</span><span class=p>,</span>
      <span class=nt>&#34;annotations&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;org.opencontainers.image.ref.name&#34;</span><span class=p>:</span> <span class=s2>&#34;myregistry:5000/nginx-app:v1.0.0&#34;</span>
      <span class=p>}</span>
    <span class=p>},</span>
    <span class=p>{</span>
      <span class=nt>&#34;mediaType&#34;</span><span class=p>:</span> <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span><span class=p>,</span>
      <span class=nt>&#34;digest&#34;</span><span class=p>:</span> <span class=s2>&#34;sha256:ef8ee90cfa9cfc7c218586dea9daa6a8d1d191b3c73be143f4120fe140dae3d0&#34;</span><span class=p>,</span>
      <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>529</span><span class=p>,</span>
      <span class=nt>&#34;annotations&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;org.opencontainers.image.ref.name&#34;</span><span class=p>:</span> <span class=s2>&#34;myregistry:5000/ubuntu:21.04&#34;</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>对应的层序结构为：
<figure><a class=lightgallery href=/posts/oras/bundle-in-bundle.svg title=/posts/oras/bundle-in-bundle.svg data-thumbnail=/posts/oras/bundle-in-bundle.svg data-sub-html="<h2>ubuntu-nginx-app:v1.0.0镜像的层序结构</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=bundle-in-bundle.svg data-srcset="/posts/oras/bundle-in-bundle.svg, bundle-in-bundle.svg 1.5x, /posts/oras/bundle-in-bundle.svg 2x" data-sizes=auto alt=/posts/oras/bundle-in-bundle.svg height=400 width=600>
</a><figcaption class=image-caption>ubuntu-nginx-app:v1.0.0镜像的层序结构</figcaption>
</figure></p>
<p>下载与加载均可以正常工作。</p>
<h3 id=补丁机制>补丁机制</h3>
<p>通过<code>ubuntu-nginx-app:v1.0.0</code>与<code>nginx-app:v1.0.0</code>两个bundle验证一下补丁机制的可用性。从上述层序结构图中可以看到后者是前者的一个子集，所以预想中patch包应包含<strong>根节点及其左右两个子分支全部节点对应的blob，及ubuntu-nginx-app:v1.0.0和ubuntu:21.04两个reference</strong>。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ cb diff myregistry:5000/ubuntu-nginx-app:v1.0.0 myregistry:5000/nginx-app:v1.0.0 -o patch
INFO<span class=o>[</span>0000<span class=o>]</span> get <span class=m>6</span> diffs
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ tree patch
patch
├── blobs
│   └── sha256
│       ├── 4451f5c7eb7af74432585f5ebfbeb01bbfc87ec4a74dc93703bdd89330559cd1
│       ├── 52e0a43cc3025f0814510022bc2bc7f64135a9f4c93944ea0b82df344cc798c0
│       ├── a2723fc64a92418869862e0a14d8e913641ba6e4bca78cf43d0db4be4c3c14fa
│       ├── bf70ebd2c444440ae068c5ccea80e2087906a825ff1019a9f6d6cbb229e33481
│       ├── ee951c00fa8985cc5f5b49f0d7fe5e456697198f24fed85142b4869083b7085b
│       └── ef8ee90cfa9cfc7c218586dea9daa6a8d1d191b3c73be143f4120fe140dae3d0
├── index.json
├── ingest
└── oci-layout

<span class=m>3</span> directories, <span class=m>8</span> files
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ cat patch/index.json <span class=p>|</span> jq .
<span class=o>{</span>
  <span class=s2>&#34;schemaVersion&#34;</span>: 2,
  <span class=s2>&#34;manifests&#34;</span>: <span class=o>[</span>
    <span class=o>{</span>
      <span class=s2>&#34;mediaType&#34;</span>: <span class=s2>&#34;application/vnd.oci.image.index.v1+json&#34;</span>,
      <span class=s2>&#34;digest&#34;</span>: <span class=s2>&#34;sha256:a2723fc64a92418869862e0a14d8e913641ba6e4bca78cf43d0db4be4c3c14fa&#34;</span>,
      <span class=s2>&#34;size&#34;</span>: 669,
      <span class=s2>&#34;annotations&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;org.opencontainers.image.ref.name&#34;</span>: <span class=s2>&#34;myregistry:5000/ubuntu-nginx-app:v1.0.0&#34;</span>
      <span class=o>}</span>
    <span class=o>}</span>,
    <span class=o>{</span>
      <span class=s2>&#34;mediaType&#34;</span>: <span class=s2>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
      <span class=s2>&#34;digest&#34;</span>: <span class=s2>&#34;sha256:ef8ee90cfa9cfc7c218586dea9daa6a8d1d191b3c73be143f4120fe140dae3d0&#34;</span>,
      <span class=s2>&#34;size&#34;</span>: 529,
      <span class=s2>&#34;annotations&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;org.opencontainers.image.ref.name&#34;</span>: <span class=s2>&#34;myregistry:5000/ubuntu:21.04&#34;</span>
      <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>]</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>上述结果表明patch包中<code>blobs</code>及<code>index.json</code>中的引用均符合我们预期。</p>
<p>清空registry并将<code>nginx-app:v1.0.0</code>load到registry中以验证应用patch的正确性。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ cb load nginx-app
INFO<span class=o>[</span>0000<span class=o>]</span> successfully push ref myregistry:5000/nginx-app:v1.0.0
INFO<span class=o>[</span>0001<span class=o>]</span> successfully push ref myregistry:5000/nginx-chart:1.0.0
$ cb patch patch
INFO<span class=o>[</span>0000<span class=o>]</span> successfully push ref myregistry:5000/ubuntu:21.04
INFO<span class=o>[</span>0001<span class=o>]</span> successfully push ref myregistry:5000/ubuntu-nginx-app:v1.0.0
</code></pre></td></tr></table>
</div>
</div><h2 id=总结>总结</h2>
<p>本文主要介绍了私有化交付下的应用打包方案，简单介绍了私有化交付的模式，提出了现有的打包方案及基于layer cache的一些优化方向。</p>
<p>本文要解决的问题是如何将一组内容从一个registry离线搬运到另一个registry中。问题的核心是如何将一组artifacts关联起来，这些内容应以什么组织形式在公司与现场之间流转。</p>
<p>通过bundle的概念对应用进行打包，便于对应用及版本进行管理。而OCI image layout是将bundle本地化的一个不错的解决思路，此架构可以与<a href=https://helm.sh/docs/topics/registries/ target=_blank rel="noopener noreffer">helm OCI</a>完全兼容。</p></div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>更新于 2021-08-26</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/container/>container</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/oci-image/ class=prev rel=prev title="OCI Image Format Spec探索与实践"><i class="fas fa-angle-left fa-fw"></i>OCI Image Format Spec探索与实践</a>
<a href=/posts/container-from-scratch/ class=next rel=next title="Containers from scratch探究">Containers from scratch探究<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=valine class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/mermaid/mermaid.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/mermaid/mermaid.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{valine:{appId:"9CFga5qIsIai65AeVF4i0mAH-gzGzoHsz",appKey:"WgXjMQASwreiUmnY5dHWWx0Y",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-cn",pageSize:10,placeholder:"发表评论...",recordIP:!0,visitor:!0}},data:{"id-1":"graph LR;\nhome[公司内发布平台]\nregistry[公网发布中心]\noffline[离线存储介质]\nscenio[私有化交付现场]\nhome --打包并发布--\u003e registry\nregistry --下载应用包--\u003eoffline\noffline --人肉搬运并上传--\u003escenio\nscenio--部署--\u003escenio","id-2":'graph TB;\nm1["app@v1.0.0\u003cbr\u003e[M1]"]\nm2["app@v1.0.1\u003cbr\u003e[M2]"]\nl1((L1))\nl2((L2))\nl3((L3))\nl4((L4))\nm1 --\u003e l1\nm1 --\u003e l2\nm1 --\u003e l3\nm2 -.-\u003e l1\nm2 -.-\u003e l2\n\nsubgraph patch-v1.0.1\nm2 -.-\u003e l4\nend',"id-3":"graph TB;\nsubgraph OCI image index\nbundle\npi[multi-platform index]\nend\nsubgraph OCI image manifest\nimage\nap[应用包]\ndp[数据包]\nend\nsubgraph OCI layer\nil[rootfs.diff]\nchart\ndata\nend\n\nbundle --\u003e pi\nbundle --\u003e ap\nbundle --\u003e dp\n\npi --\u003e image\n\nimage --\u003e il\nap --\u003e chart\ndp --\u003e data"},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},search:{algoliaAppID:"LX1FO3SR9Q",algoliaIndex:"blog",algoliaSearchKey:"e313cef40f53bf69fe7e593c2369a811",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>